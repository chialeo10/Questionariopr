<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Questionario Competenze Digitali Over 50</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Segoe+UI:wght@400;600&display=swap');
    :root{
      --primary:#3498db;--primary-dark:#2980b9;--text:#2c3e50;--muted:#6b7280;
      --bg:#f5f7fa;--card:#fff;--border:#e0e0e0;--shadow:0 6px 20px rgba(0,0,0,0.05);--radius:12px;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:'Segoe UI',Arial,sans-serif;margin:0;color:#333}
    .title-box{font-family:'Playfair Display',serif;font-size:34px;font-weight:600;color:var(--text);text-align:center;padding:34px 18px 8px;background:linear-gradient(to right,#fff,#f2f2f2);border-bottom:1px solid #ddd;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
    .title-box::after{content:'';display:block;width:60px;height:3px;background:var(--primary);margin:10px auto 0;border-radius:2px}
    .question-box{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);max-width:900px;margin:28px auto;padding:24px}
    .header-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    #user-name{flex:1;min-width:220px;padding:10px 12px;font-size:15px;border:1px solid #ccc;border-radius:8px}
    #progress{font-size:14px;color:var(--muted);margin-left:auto}
    .pill{display:inline-block;background:#eef6fd;color:#2468a2;border:1px solid #cde4fb;padding:4px 10px;border-radius:999px;font-size:12px;margin-left:8px}
    .question-title{font-size:20px;font-weight:600;margin:14px 0;color:var(--text)}
    .question-sub{font-size:14px;color:var(--muted);margin:4px 0 16px}
    .options{display:flex;flex-direction:column;gap:8px;margin:8px 0}
    .opt{display:flex;align-items:flex-start;gap:10px;padding:10px;border:1px solid #eef4fa;border-radius:10px}
    .opt:hover{background:#fbfdff}
    .img-wrap{margin:18px 0;text-align:center}
    .img-wrap img{max-width:100%;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .upload-wrap{margin-top:10px;font-size:14px}
    .button-box{display:flex;gap:10px;justify-content:center;margin-top:18px}
    button{background:var(--primary);color:#fff;border:none;padding:10px 18px;border-radius:30px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,0.08)}
    button.secondary{background:#e5e7eb;color:#111}
    .muted{color:var(--muted);font-size:13px;margin-top:10px}
    .matrix{width:100%;border-collapse:collapse;margin-top:8px}
    .matrix th,.matrix td{border:1px solid #e9eef5;padding:8px;text-align:center}
    .matrix th{background:#f8fafc}
    input[type="text"], input[type="date"], select{padding:8px;border-radius:6px;border:1px solid #e3e7ee;width:100%}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="title-box">Questionario Competenze Digitali Over 50</div>

  <div class="question-box" id="app">
    <div class="header-row">
      <input type="text" id="user-name" placeholder="Inserisci il tuo nome (richiesto)" />
      <div id="progress">Domanda 1 di â€¦</div>
    </div>

    <div id="q-wrap"></div>

    <div class="button-box">
      <button class="secondary" id="backBtn" disabled>Indietro</button>
      <button id="nextBtn">Avanti</button>
    </div>

    <div class="muted" id="helper"></div>
  </div>

<script>
/* ===========================
   CONFIG SUPABASE (confermati)
   =========================== */
const SUPABASE_URL = 'https://lteztcnhpkleuvqeaphq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0ZXp0Y25ocGtsZXV2cWVhcGhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MzE5MjYsImV4cCI6MjA2ODUwNzkyNn0.Wbvy9R5kVYRAjxzhbxK4d76ctqAT-ZyX4kaL7nqGFnc';

async function salvaRispostaSupabase(payload){
  // payload es: { nome, domanda, risposta, corretto, esito, foto }
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/Risposte`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const t = await res.text();
      console.error('Supabase error:', t);
      // mostriamo un messaggio non bloccante
      $('#helper').text('Errore salvataggio (controlla console).');
    }
  }catch(e){
    console.error('Network error:', e);
    $('#helper').text('Errore di rete durante il salvataggio.');
  }
}

/* ===========================
   DOMANDE - dal file IT_Questionnaire_V4.docx
   - id: codice Q.xxx
   - tipi: single, multi, text, date, matrix, matrixPerItem, ynList
   - alcune domande hanno image: percorso relativo in /www
   =========================== */
const Q = [
  // SEZIONE I: Socio-demografiche
  {id:'Q.001', section:'SOCIO', text:'Data di nascita', type:'date'},
  {id:'Q.002', section:'SOCIO', text:'Genere', type:'single', options:['Maschio','Femmina']},
  {id:'Q.003', section:'SOCIO', text:'Regione di residenza', type:'text'},
  {id:'Q.004', section:'SOCIO', text:'In che tipo di zona si trova la casa?', type:'single', options:[
    'In una grande cittÃ ',
    'Nella periferia o lâ€™hinterland di una grande cittÃ ',
    'In una cittÃ ',
    'In una cittadina',
    'In campagna o in un piccolo centro'
  ]},
  {id:'Q.005', section:'SOCIO', text:"Fra quelli elencati, qual Ã¨ il titolo di studio piÃ¹ elevato da Lei ottenuto?", type:'single', options:[
    'Nessun titolo',
    'Qualche anno di istruzione (ma senza aver conseguito l\'esame di seconda elementare)',
    'Esame di seconda elementare',
    'Licenza elementare',
    'Scuola media o avviamento professionale',
    'Diploma ginnasiale',
    'Diploma di scuola professionale, scuola magistrale o istituto dâ€™arte (3 anni)',
    'Diploma di scuola magistrale o liceo artistico (4 anni)',
    'MaturitÃ  liceale (classico, scientifico, linguistico, artistico, socio-psico-pedagogico)',
    'MaturitÃ  tecnica, professionale o istituto dâ€™arte (5 anni)',
    'Altro titolo di studio non post-secondario'
  ]},
  {id:'Q.006', section:'SOCIO', text:'Quale delle seguenti categorie descrive meglio la sua attuale situazione lavorativa?', type:'single', options:[
    'In pensione da lavoro','Lavoratore dipendente o indipendente (incluso lavoro in attivitÃ  di famiglia)','Disoccupato/a','Malato/a cronico/a o disabile','Casalingo/a'
  ]},
  {id:'Q.007', section:'SOCIO', text:'Qual Ã¨ il suo stato civile?', type:'single', options:[
    'Coniugato/a e convivente con il coniuge','Convivenza ufficialmente riconosciuta','Coniugato/a, ma non convivente con il coniuge','Mai sposato/a','Divorziato/a','Vedovo/a','Altro'
  ]},

  // SEZIONE II: Dispositivi
  {id:'Q.008', section:'DISPOSITIVI', text:'Quali dei seguenti dispositivi possiedi o a quali hai accesso? (Scelta multipla)', type:'multi', options:[
    'Computer fisso o portatile','Smartphone','Tablet / iPad','Smart TV','Altro (specificare)','Nessun dispositivo digitale'
  ], allowOther:true},

  {id:'Q.009', section:'DISPOSITIVI', showIf:{id:'Q.008', includes:'Nessun dispositivo digitale'}, text:'Di cosa avresti bisogno per imparare a usare un dispositivo digitale? (Risposta multipla)', type:'multi', options:[
    'Avere un dispositivo personale','Pratica e dedizione','Interesse e iniziativa','Memoria e concentrazione'
  ]},

  {id:'Q.010', section:'DISPOSITIVI', showIf:{id:'Q.008', includes:'Nessun dispositivo digitale'}, text:'Quali difficoltÃ  incontri (o pensi potresti incontrare) nellâ€™imparare a usare un dispositivo digitale? (Risposta multipla)', type:'multi', options:[
    'DifficoltÃ  pratiche','DifficoltÃ  di lettura e scrittura','Memoria e agilitÃ  mentale','Paura del dispositivo o timore di romperlo'
  ]},

  {id:'Q.011', section:'DISPOSITIVI', showIf:{id:'Q.008', includes:'Nessun dispositivo digitale'}, text:'Cosa pensi potrebbe aiutarti di piÃ¹ ad imparare a usare un dispositivo digitale? (Risposta multipla)', type:'multi', options:[
    'Avere piÃ¹ tempo per fare pratica','Ricevere spiegazioni semplici e chiare','Avere qualcuno che ti supporta e ti guida','Ripetere spesso le stesse operazioni fino a sentirti sicuro'
  ]},

  {id:'Q.012', section:'DISPOSITIVI', showIfNotSelected:{id:'Q.008', value:'Nessun dispositivo digitale'}, text:'Per ciascun dispositivo selezionato, rispondi: (Da quanto tempo / Agio / Frequenza)', type:'matrixPerItem', perItemSource:'Q.008', columns:[
    {key:'tempo', label:'Da quanto tempo lo utilizzi?', choices:['Meno di 1 anno','Da 1 a 3 anni','Da 3 a 5 anni','PiÃ¹ di 5 anni']},
    {key:'agio', label:'Quanto ti senti a tuo agio nellâ€™utilizzarlo?', choices:['Per niente','Poco','Abbastanza','Molto','Completamente a mio agio']},
    {key:'frequenza', label:'Con quale frequenza lo usi?', choices:['Spesso','Occasionalmente','Mai']}
  ]},

  // Domande aggiuntive per Computer
  {id:'Q.015', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Computer fisso o portatile'}], text:'(Computer) Chi ti ha insegnato ad utilizzare il computer?', type:'multi', options:[
    'Insegnante','Famiglia','Libri','Autodidatta','Colleghi','Amici','Tutorial online','Altri'
  ]},
  {id:'Q.016', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Computer fisso o portatile'}], text:'(Computer) Quale sistema operativo possiede il tuo computer?', type:'single', options:[
    'IOS','Windows','Linux','Altro','Non lo so'
  ]},
  {id:'Q.017', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Computer fisso o portatile'}], text:'(Computer) Quale browser (sistema di ricerca) utilizzi sul tuo computer?', type:'single', options:[
    'Google Chrome','Safari','Microsoft Edge','Mozilla Firefox','Altro','Non lo so'
  ]},
  {id:'Q.018', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Computer fisso o portatile'}], text:'(Computer) Quali app usi piÃ¹ frequentemente? (Risposta multipla)', type:'multi', options:[
    'Suite Office (Word, Excel, ecc.)','App per videoconferenze (Zoom, Teams, Meet, ecc.)','App per note e organizzazione (Evernote, Notion, ecc.)','App per gestione di progetti','Altro (specificare)'
  ], allowOther:true},
  {id:'Q.019', section:'DISPOSITIVI', showIf:{id:'Q.018', includes:'Suite Office (Word, Excel, ecc.)'}, text:'(Suite Office) Quale programma della Suite Office utilizzi di piÃ¹? (Scelta multipla)', type:'multi', options:[
    'Microsoft Word','Microsoft Excel','Microsoft PowerPoint','Microsoft OneNote','Altro (specificare)'
  ], allowOther:true},

  // Domande per Smartphone / Tablet
  {id:'Q.020', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Smartphone'}], text:'(Smartphone) Quale sistema operativo possiede il tuo Smartphone ?', type:'single', options:[
    'IOS','Android','Windows Mobile','Altro','Non lo so'
  ]},
  {id:'Q.021', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Smartphone'}], text:'(Smartphone) Quale browser utilizzi sul tuo smartphone?', type:'single', options:[
    'Google Chrome','Safari','Samsung Internet','Mozilla Firefox','Altro','Non lo so'
  ]},
  {id:'Q.022', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Smartphone'},{id:'Q.008', includes:'Tablet / iPad'}], text:'Che cosâ€™Ã¨ il T9 nei telefoni cellulari?', type:'single', options:[
    'Un sistema di scrittura predittiva che suggerisce le parole mentre digiti',
    'Un modello di smartphone di nuova generazione',
    'Unâ€™app per la messaggistica istantanea',
    'Un formato di file per immagini',
    'Non lo so'
  ], correct:'Un sistema di scrittura predittiva che suggerisce le parole mentre digiti'},
  {id:'Q.023', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Smartphone'},{id:'Q.008', includes:'Tablet / iPad'}], text:'Sai cosa Ã¨ uno screenshot?', type:'single', options:['SÃ¬','No']},

  // Smart TV
  {id:'Q.024', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Smart TV'}], text:'(Smart TV) Cosa guardi principalmente? (Risposta multipla)', type:'multi', options:[
    'Canali televisivi tradizionali','Piattaforme di streaming (Netflix, Prime Video, Disney+, ecc.)','YouTube o simili','Servizi on demand delle emittenti TV','Altro (specificare)'
  ], allowOther:true},
  {id:'Q.025', section:'DISPOSITIVI', showIfAny:[{id:'Q.008', includes:'Smart TV'}], text:'(Smart TV) Quanto spesso utilizzi le funzioni â€œsmartâ€ della TV?', type:'single', options:[
    'Quasi sempre','Spesso','Occasionalmente','Raramente','Mai'
  ]},

  // SEZIONE III: INTERNET
  {id:'Q.026', section:'INTERNET', text:'Tramite quale connessione accedi a Internet? (Scelta multipla)', type:'multi', options:[
    'Wi-Fi di casa','Rete mobile (4G/5G)','Wi-Fi pubblico','Non utilizzo Internet'
  ]},
  {id:'Q.027', section:'INTERNET', showIfNotSelected:{id:'Q.026', value:'Non utilizzo Internet'}, text:'Negli ultimi 3 mesi hai utilizzato Internet per acquistare beni o servizi?', type:'single', options:['SÃ¬','No','Non rispondo']},
  {id:'Q.028', section:'INTERNET', showIf:{id:'Q.027', equals:'SÃ¬'}, text:'Per cosa hai usato Internet negli acquisti? (Frequenza per ciascuna voce)', type:'matrix', rows:[
    'Acquistare articoli fisici (abbigliamento, elettronica, libri, ecc.)',
    'Ordinare generi alimentari o fare la spesa online',
    'Prenotare viaggi, biglietti o alloggi',
    'Pagare bollette o tasse online',
    'Ottenere coupon o sconti digitali',
    'Comprare o vendere su marketplace (Amazon, eBay, Zalando)',
    'Comprare o vendere su siti di annunci (Subito.it, Vinted)'
  ], columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai']},

  {id:'Q.029', section:'INTERNET', showIfNotSelected:{id:'Q.026', value:'Non utilizzo Internet'}, text:'Negli ultimi 3 mesi hai utilizzato Internet per comunicare con altre persone?', type:'single', options:['SÃ¬','No','Non rispondo']},
  {id:'Q.030', section:'INTERNET', showIf:{id:'Q.029', equals:'SÃ¬'}, text:'Con quale frequenza hai svolto le seguenti attivitÃ  online per comunicare?', type:'matrix', rows:[
    'Inviare o leggere e-mail',
    'Fare videochiamate (Meet, Zoom, Facetime, WhatsApp video)',
    'Chattare su servizi di messaggistica istantanea (WhatsApp, Telegram, Messenger)',
    'Usare social network per comunicare (Facebook, Instagram, LinkedIn)'
  ], columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai']},

  {id:'Q.031', section:'INTERNET', showIfNotSelected:{id:'Q.026', value:'Non utilizzo Internet'}, text:'Negli ultimi 3 mesi hai utilizzato Internet per informarti o cercare contenuti?', type:'single', options:['SÃ¬','No','Non rispondo']},
  {id:'Q.032', section:'INTERNET', showIf:{id:'Q.031', equals:'SÃ¬'}, text:'Quali tipi di contenuti hai cercato? (Frequenza per ciascuna voce)', type:'matrix', rows:[
    'Leggere notizie o articoli di attualitÃ ',
    'Cercare informazioni su salute e assistenza sanitaria',
    'Guardare film, programmi TV o video in streaming',
    'Fare ricerche su Wikipedia o siti simili',
    'Cercare informazioni su hobby o interessi personali (ricette, giardinaggio, bricolage, ecc.)',
    'Cercare indicazioni stradali o mappe',
    'Seguire i mercati finanziari'
  ], columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai']},

  {id:'Q.033', section:'INTERNET', showIfNotSelected:{id:'Q.026', value:'Non utilizzo Internet'}, text:'Negli ultimi 3 mesi hai utilizzato Internet per servizi pubblici?', type:'single', options:['SÃ¬','No','Non rispondo']},
  {id:'Q.034', section:'INTERNET', showIf:{id:'Q.033', equals:'SÃ¬'}, text:'In che modo? (Frequenza per ciascuna voce)', type:'matrix', rows:[
    'Prenotare visite mediche online',
    'Accedere a servizi pubblici digitali (SPID, CIE, Fascicolo Sanitario, Agenzia delle Entrate, INPS)',
    'Altro (da specificare)'
  ], columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai'], rowOther:true},

  {id:'Q.035', section:'INTERNET', text:'Negli ultimi 3 mesi hai utilizzato Internet per la gestione del patrimonio o per condurre investimenti online?', type:'single', options:['SÃ¬','No','Non rispondo']},
  {id:'Q.036', section:'INTERNET', showIf:{id:'Q.035', equals:'SÃ¬'}, text:'Indica con che frequenza svolgi le seguenti operazioni finanziarie', type:'matrix', rows:[
    'Accedi al tuo conto online per controllare il saldo',
    'Utilizzi app per monitorare le tue spese personali',
    'Usi lo smartphone per effettuare bonifici o pagamenti',
    'Controlli o ricevi notifiche sullâ€™andamento dei mercati azionari tramite app o siti',
    'Effettui operazioni di acquisto o vendita di azioni'
  ], columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai']},

  // SEZIONE IV: LAVORO
  {id:'Q.037', section:'LAVORO', text:'Attualmente svolgi attivitÃ  lavorativa ?', type:'single', options:['SÃ¬','No']},
  {id:'Q.038', section:'LAVORO', showIf:{id:'Q.037', equals:'SÃ¬'}, text:'(Se lavori) Rispondi SÃ¬/No alle seguenti domande:', type:'ynList', items:[
    'Hai mai utilizzato computer o Internet per lavoro?',
    'Hai inviato candidature online negli ultimi 12 mesi?',
    'Hai partecipato a corsi di formazione online negli ultimi 12 mesi?',
    'Hai partecipato a riunioni online negli ultimi 12 mesi?',
    'Hai mai utilizzato strumenti di condivisione file (Google Drive, Dropbox)?',
    'Lavori o hai lavorato mai in smart working?'
  ]},
  {id:'Q.039', section:'LAVORO', showIf:{id:'Q.037', equals:'SÃ¬'}, text:'Come valuteresti le tue competenze informatiche nel lavoro?', type:'matrix', rows:[
    'Applicazioni di videoscrittura (es. Word)',
    'Applicazioni di fogli di calcolo (es. Excel)',
    'Applicazioni per database',
    'Applicazioni per presentazioni (es. PowerPoint)',
    'Applicazioni multimediali (audio, video, immagini)',
    'Applicazioni per la progettazione di siti web',
    'Motori di ricerca sul web (es. Google)',
    'Applicazioni di comunicazione (es. email, videoconferenze)'
  ], columns:['Nessuna','Base','Intermedia','Avanzata']},

  // SEZIONE V: SICUREZZA
  {id:'Q.040', section:'SICUREZZA', text:'Solitamente prendi precauzioni per proteggere i tuoi dati online?', type:'single', options:['SÃ¬','No']},
  {id:'Q.041', section:'SICUREZZA', showIf:{id:'Q.040', equals:'SÃ¬'}, text:'Se SÃ¬: seleziona le pratiche che adotti (SÃ¬/No per ciascuna).', type:'ynList', items:[
    'Utilizzi password complesse e diverse?',
    'Cambi regolarmente le password?',
    'Hai mai installato e/o aggiornato un antivirus?',
    'Controlli solitamente le impostazioni di privacy sui social?'
  ]},
  // Q.042: assegna un numero da 1 a 4 a ciascuna password -> implementato come matrix (righe = password, colonne = 1..4)
  {id:'Q.042', section:'SICUREZZA', text:'Assegna un numero da 1 (piÃ¹ sicura) a 4 (meno sicura) a ciascuna password.', type:'matrix', rows:[
    '1234567','Maria1970','P4ssw0rd!','Tr*9kLm!28#q'
  ], columns:['1','2','3','4']},

  // SEZIONE VI: ICONE / CONOSCENZE (con immagini)
  {id:'Q.043', section:'ICONE', text:'Quando compare questo simbolo vicino allâ€™indirizzo di un sito web, cosa significa?', type:'single', options:[
    'A. La connessione tra il tuo dispositivo e il sito Ã¨ sicura',
    'B. Il sito Ã¨ stato visitato di recente',
    'C. Il sito Ã¨ a pagamento',
    'D. Il sito non funziona senza password'
  ], correct:'A. La connessione tra il tuo dispositivo e il sito Ã¨ sicura', image:'www/lucchetto.jpg'},
  {id:'Q.044', section:'ICONE', text:'Cosa permette di fare questa icona sullo smartphone o computer?', type:'single', options:[
    'A. Aprire il menu delle impostazioni',
    'B. Avviare la fotocamera',
    'C. Spegnere il dispositivo',
    'D. Aggiornare unâ€™applicazione'
  ], correct:'A. Aprire il menu delle impostazioni', image:'www/ingranaggio.jpg'},
  {id:'Q.045', section:'ICONE', text:'Cosa rappresenta solitamente questa icona?', type:'single', options:[
    'A. Email o messaggi',
    'B. Rubrica dei contatti',
    'C. Lista degli appuntamenti',
    'D. Documenti salvati'
  ], correct:'A. Email o messaggi', image:'www/email.jpg'},
  {id:'Q.046', section:'ICONE', text:'Quando questa icona Ã¨ piena e luminosa, cosa indica?', type:'single', options:[
    'A. Sei connesso a Internet tramite rete wireless',
    'B. Il dispositivo sta scaricando dati',
    'C. Ãˆ attiva la connessione Bluetooth',
    'D. Stai guardando un video in streaming'
  ], correct:'A. Sei connesso a Internet tramite rete wireless', image:'www/wifi.png'},
  {id:'Q.047', section:'ICONE', text:'A cosa serve questa funzione su smartphone, tablet o computer?', type:'single', options:[
    'A. Collegare dispositivi senza fili (cuffie, casse, tastiere)',
    'B. Navigare in Internet ad alta velocitÃ ',
    'C. Bloccare lâ€™accesso al dispositivo',
    'D. Salvare file nella memoria interna'
  ], correct:'A. Collegare dispositivi senza fili (cuffie, casse, tastiere)', image:'www/blue.jpg'},
  {id:'Q.048', section:'ICONE', text:'Cosa puoi fare con questo tipo di codice?', type:'single', options:[
    'A. Scansionarlo per aprire un link, ottenere informazioni o accedere a un servizio',
    'B. Usarlo per aumentare la velocitÃ  di connessione Internet',
    'C. Inserirlo come password per accedere al computer',
    'D. Stamparlo per decorare un documento'
  ], correct:'A. Scansionarlo per aprire un link, ottenere informazioni o accedere a un servizio', image:'www/download.png'},
  {id:'Q.049', section:'ICONE', text:'Qual Ã¨ il â€œcervello principaleâ€ del computer?', type:'single', options:['CPU','LAN','RAM','ROM'], correct:'CPU'},

  // SEZIONE VII: FINALi (Likert)
  {id:'Q.050', section:'FINALE', text:'Indica in che misura sei dâ€™accordo con le seguenti affermazioni.', type:'matrix', rows:[
    'Mi piace usare i dispositivi digitali.',
    'Mi sento a mio agio nellâ€™utilizzarli.',
    'Sono disposto/a a imparare nuove funzioni dei dispositivi digitali.',
    'Penso che i dispositivi digitali siano complicati da usare.',
    'Mi sento in difficoltÃ  quando altre persone parlano di tecnologia digitale.',
    'Credo che sia importante per me imparare a usare meglio i dispositivi digitali.',
    'Mi piacerebbe usare piÃ¹ spesso i dispositivi digitali nella vita quotidiana.',
    'Penso che i dispositivi digitali possano rendere piÃ¹ semplici alcune attivitÃ  (es. viaggiare, pagare bollette, cercare informazioni).',
    'Credo che dovrebbero esistere piÃ¹ corsi o iniziative di formazione per aiutare persone della mia etÃ  a usare i dispositivi digitali.'
  ], columns:['Fortemente dâ€™accordo','Dâ€™accordo','Indeciso','In disaccordo','Fortemente in disaccordo']}
];

/* ===========================
   Stato e helper per visibilitÃ 
   =========================== */
const state = { index: 0, answers: {}, history: [] };

function visibleQuestions(){
  const ans = state.answers;
  return Q.filter(q=>{
    if(q.showIf){
      const v = ans[q.showIf.id];
      if(q.showIf.equals !== undefined && v !== q.showIf.equals) return false;
      if(q.showIf.includes !== undefined){
        const vv = ans[q.showIf.id] || [];
        if(!Array.isArray(vv) || !vv.includes(q.showIf.includes)) return false;
      }
    }
    if(q.showIfAny){
      const ok = q.showIfAny.some(cond=>{
        const v = ans[cond.id];
        if(cond.equals !== undefined) return v === cond.equals;
        if(cond.includes !== undefined){
          const vv = ans[cond.id] || [];
          return Array.isArray(vv) && vv.includes(cond.includes);
        }
        return false;
      });
      if(!ok) return false;
    }
    if(q.showIfNotSelected){
      const v = ans[q.showIfNotSelected.id] || [];
      if(Array.isArray(v) && v.includes(q.showIfNotSelected.value)) return false;
    }
    return true;
  });
}

function updateProgress(){
  const V = visibleQuestions();
  const pos = Math.min(state.index + 1, V.length);
  $('#progress').text(`Domanda ${pos} di ${V.length}`);
  $('#backBtn').prop('disabled', state.history.length === 0);
}

/* ===========================
   Render domanda corrente
   =========================== */
function renderCurrent(){
  const V = visibleQuestions();
  if(state.index >= V.length){
    $('#q-wrap').html(`<div class="question-title">Questionario completato! ðŸŽ‰</div><div class="muted">Grazie per la partecipazione. Le risposte sono state registrate.</div>`);
    $('#nextBtn, #backBtn').addClass('hidden');
    return;
  }

  const q = V[state.index];
  const val = state.answers[q.id];
  let html = `<div class="pill">${q.section}</div>`;
  html += `<div class="question-title">${q.text}</div>`;

  if(q.image){
    html += `<div class="img-wrap"><img src="${q.image}" alt="Immagine domanda" /></div>`;
  }

  // render by type
  if(q.type === 'single'){
    html += `<div class="options">` + q.options.map((op,i)=>`<label class="opt"><input type="radio" name="${q.id}" value="${op}" ${val===op?'checked':''}/> <span>${op}</span></label>`).join('') + `</div>`;
  } else if(q.type === 'multi'){
    html += `<div class="options">` + q.options.map(op=>`<label class="opt"><input type="checkbox" name="${q.id}" value="${op}" ${(Array.isArray(val) && val.includes(op))?'checked':''}/> <span>${op}</span></label>`).join('') + `</div>`;
    if(q.allowOther){
      const otherVal = Array.isArray(val) ? (val.find(v=>v.startsWith('Altro: ')) || '').replace('Altro: ','') : '';
      html += `<div style="margin-top:8px"><label class="opt"><input type="checkbox" id="${q.id}_other_chk" ${otherVal ? 'checked' : ''}/> Altro (specificare)</label><input type="text" id="${q.id}_other_txt" placeholder="Specifica..." value="${otherVal||''}" style="margin-top:6px;padding:8px;border:1px solid #e9eef5;border-radius:6px;width:100%"/></div>`;
    }
  } else if(q.type === 'text' || q.type === 'date'){
    html += `<input type="${q.type === 'date' ? 'date' : 'text'}" id="${q.id}_txt" value="${val||''}" style="padding:10px;border:1px solid #e9eef5;border-radius:6px;width:100%"/>`;
  } else if(q.type === 'ynList'){
    html += `<div>`;
    q.items.forEach((it, idx)=>{
      const cur = (val && val[it]) || '';
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f3f6fb"><div style="flex:1">${it}</div><div style="min-width:160px"><label style="margin-right:8px"><input type="radio" name="${q.id}_${idx}" value="SÃ¬" ${cur==='SÃ¬'?'checked':''}/> SÃ¬</label><label><input type="radio" name="${q.id}_${idx}" value="No" ${cur==='No'?'checked':''}/> No</label></div></div>`;
    });
    html += `</div>`;
  } else if(q.type === 'matrix'){
    html += `<table class="matrix"><thead><tr><th>Voce</th>${q.columns.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>`;
    q.rows.forEach((r, ri)=>{
      const rowVal = (val && val[r]) || '';
      html += `<tr><td style="text-align:left">${r}`;
      if(q.rowOther && r.toLowerCase().includes('altro')) {
        // show input for other
        html += `<div style="margin-top:6px"><input type="text" id="${q.id}_other" placeholder="Specifica..." value="${(val && val.__otherText) || ''}" style="padding:6px;border:1px solid #e9eef5;border-radius:6px;width:100%"/></div>`;
      }
      html += `</td>`;
      q.columns.forEach(c=>{
        html += `<td><input type="radio" name="${q.id}_r${ri}" value="${c}" ${rowVal===c?'checked':''}/></td>`;
      });
      html += `</tr>`;
    });
    html += `</tbody></table>`;
  } else if(q.type === 'matrixPerItem'){
    const items = (state.answers[q.perItemSource] || []).slice();
    if(!items.length){
      html += `<div class="muted">Nessun dispositivo selezionato.</div>`;
    } else {
      html += `<table class="matrix"><thead><tr><th>Dispositivo</th>${q.columns.map(c=>`<th>${c.label}</th>`).join('')}</tr></thead><tbody>`;
      items.forEach((item, i)=>{
        // item potrebbe essere "Altro: testo" -> manteniamo cosÃ¬
        const rowVal = (val && val[item]) || {};
        html += `<tr><td style="text-align:left">${item}</td>`;
        q.columns.forEach(col=>{
          const current = rowVal[col.key] || '';
          html += `<td><select id="${q.id}_${i}_${col.key}" style="padding:6px;border:1px solid #e9eef5;border-radius:6px"><option value="">â€”</option>${col.choices.map(ch=>`<option value="${ch}" ${current===ch?'selected':''}>${ch}</option>`).join('')}</select></td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table><div class="question-sub muted" style="margin-top:8px">Compila le colonne per ogni dispositivo selezionato.</div>`;
    }
  }

  // upload immagine per ogni domanda
  html += `<div class="upload-wrap">Carica immagine (opzionale): <input type="file" id="${q.id}_file" accept="image/*" /></div>`;

  $('#q-wrap').html(html);
  updateProgress();
}

/* ===========================
   Leggi risposta da UI
   =========================== */
function readAnswer(q){
  if(q.type === 'single'){
    return $(`input[name="${q.id}"]:checked`).val() || null;
  }
  if(q.type === 'multi'){
    const arr = Array.from($(`input[name="${q.id}"]:checked`)).map(x=>x.value);
    if(q.allowOther){
      const otherChk = $(`#${q.id}_other_chk`).prop('checked');
      const otherTxt = ($(`#${q.id}_other_txt`).val()||'').trim();
      if(otherChk && otherTxt) arr.push('Altro: ' + otherTxt);
    }
    return arr.length ? arr : null;
  }
  if(q.type === 'text' || q.type === 'date'){
    const v = $(`#${q.id}_txt`).val() || null;
    return v ? v : null;
  }
  if(q.type === 'ynList'){
    const res = {}; let ok = true;
    q.items.forEach((it, idx)=>{
      const v = $(`input[name="${q.id}_${idx}"]:checked`).val();
      if(!v) ok = false;
      res[it] = v || '';
    });
    return ok ? res : null;
  }
  if(q.type === 'matrix'){
    const res = {}; let ok = true;
    q.rows.forEach((r, ri)=>{
      const v = $(`input[name="${q.id}_r${ri}"]:checked`).val();
      if(!v) ok = false;
      res[r] = v || '';
    });
    if(q.rowOther){
      res.__otherText = $(`#${q.id}_other`).val() || '';
    }
    return ok ? res : null;
  }
  if(q.type === 'matrixPerItem'){
    const items = state.answers[q.perItemSource] || [];
    const res = {}; let ok = true;
    items.forEach((item, i)=>{
      res[item] = {};
      (q.columns || []).forEach(col=>{
        const v = $(`#${q.id}_${i}_${col.key}`).val() || '';
        if(!v) ok = false;
        res[item][col.key] = v;
      });
    });
    return ok ? res : null;
  }
  return null;
}

/* ===========================
   Convert file -> base64
   =========================== */
function toBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ===========================
   Build payloads e salva su Supabase
   - domanda: solo codice (es. Q.0281)
   - ogni riga inviata separatamente per matrix/matrixPerItem/ynList
   - foto (base64) inclusa nel payload, se presente
   =========================== */
async function buildAndSave(q, ans){
  const nome = ($('#user-name').val()||'').trim();
  if(!nome) { $('#helper').text('Inserisci il tuo nome per continuare.'); $('#user-name').focus(); throw 'no-name'; }

  // file
  let fotoBase64 = null;
  const fileInput = $(`#${q.id}_file`)[0];
  if(fileInput && fileInput.files && fileInput.files[0]){
    try { fotoBase64 = await toBase64(fileInput.files[0]); } catch(e){ console.error('file->base64 error', e); }
  }

  const basePayload = (cod, resp, correct=null) => {
    let esito = 'n/a';
    if(correct !== null){
      if(Array.isArray(resp)){
        // compare arrays (order-insensitive)
        const left = Array.from(resp).slice().sort();
        const right = Array.isArray(correct) ? Array.from(correct).slice().sort() : [String(correct)];
        esito = JSON.stringify(left) === JSON.stringify(right) ? 'corretto' : 'sbagliato';
      } else {
        esito = (String(resp) === String(correct)) ? 'corretto' : 'sbagliato';
      }
    }
    return {
      nome,
      domanda: cod,
      risposta: (typeof resp === 'string') ? resp : JSON.stringify(resp),
      corretto: correct || null,
      esito,
      foto: fotoBase64
    };
  };

  const rows = [];

  if(q.type === 'single' || q.type === 'text' || q.type === 'date'){
    rows.push(basePayload(q.id, ans, q.correct ?? null));
  } else if(q.type === 'multi'){
    rows.push(basePayload(q.id, ans, q.correct ?? null));
  } else if(q.type === 'ynList'){
    // ogni item salva come Q.0381, Q.0382...
    q.items.forEach((it, idx)=>{
      const code = `${q.id}${idx+1}`;
      rows.push(basePayload(code, ans[it] || '', null));
    });
  } else if(q.type === 'matrix'){
    q.rows.forEach((r, i)=>{
      const code = `${q.id}${i+1}`;
      const resp = ans[r] || '';
      rows.push(basePayload(code, resp, null));
    });
    if(ans.__otherText && ans.__otherText.trim()){
      const code = `${q.id}${q.rows.length+1}`;
      rows.push(basePayload(code, ans.__otherText, null));
    }
  } else if(q.type === 'matrixPerItem'){
    // items order = state.answers[q.perItemSource] (array)
    const items = state.answers[q.perItemSource] || [];
    const perDeviceCount = q.columns.length;
    items.forEach((item, devIdx)=>{
      const dataObj = ans[item] || {};
      q.columns.forEach((col, colIdx)=>{
        const subIndex = (devIdx * perDeviceCount) + (colIdx + 1); // 1-based
        const code = `${q.id}${subIndex}`;
        const value = dataObj[col.key] || '';
        rows.push(basePayload(code, { dispositivo: item, campo: col.key, valore: value }, null));
      });
    });
  } else {
    rows.push(basePayload(q.id, ans, null));
  }

  // invia in sequenza
  for(const r of rows){
    await salvaRispostaSupabase(r);
  }
}

/* ===========================
   Next / Back handling
   =========================== */
$('#nextBtn').on('click', async ()=>{
  const V = visibleQuestions();
  const q = V[state.index];

  // controllo nome
  const nome = ($('#user-name').val()||'').trim();
  if(!nome){ $('#helper').text('Inserisci il tuo nome per continuare.'); $('#user-name').focus(); return; }
  $('#helper').text('');

  // leggere risposta
  const ans = readAnswer(q);
  if(!ans){
    $('#helper').text('Per favore rispondi alla domanda prima di procedere.');
    return;
  }

  // salva nello stato
  state.answers[q.id] = ans;

  // salvataggio su Supabase (mostra messaggio)
  $('#helper').text('Salvataggio in corso...');
  try{
    await buildAndSave(q, ans);
    $('#helper').text('Risposta salvata.');
  }catch(e){
    if(e === 'no-name') return;
    console.error('Errore buildAndSave', e);
    $('#helper').text('Errore durante il salvataggio.');
  }

  // avanzamento
  state.history.push(state.index);
  state.index = Math.min(state.index + 1, V.length);
  renderCurrent();
});

$('#backBtn').on('click', ()=>{
  if(state.history.length > 0){
    state.index = state.history.pop();
    renderCurrent();
  }
});

// salva nome su blur (opzionale)
$('#user-name').on('blur', ()=>{
  const nome = ($('#user-name').val()||'').trim();
  if(nome){
    // eventuale logica "inizio sessione" -> non richiesta ora
  }
});

// inizializza
$(document).ready(()=>{
  renderCurrent();
});
</script>
</body>
</html>
