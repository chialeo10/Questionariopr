<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Questionario Competenze Digitali</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Segoe+UI:wght@400;600&display=swap');

    :root{
      --primary:#3498db;
      --primary-dark:#2980b9;
      --text:#2c3e50;
      --muted:#6b7280;
      --bg:#f5f7fa;
      --card:#ffffff;
      --border:#e0e0e0;
      --shadow:0 6px 20px rgba(0,0,0,0.05);
      --radius:12px;
    }

    *{box-sizing:border-box}
    body{
      background-color:var(--bg);
      font-family:'Segoe UI','Helvetica Neue',Arial,sans-serif;
      margin:0;
      color:#333;
    }
    .title-box{
      font-family:'Playfair Display',serif;
      font-size:38px;
      font-weight:600;
      color:var(--text);
      text-align:center;
      padding:40px 20px 10px;
      background:linear-gradient(to right,#ffffff,#f2f2f2);
      border-bottom:1px solid #ddd;
      box-shadow:0 4px 6px rgba(0,0,0,0.05);
      position:relative;
    }
    .title-box::after{
      content:'';
      display:block;
      width:60px;height:3px;background-color:var(--primary);
      margin:10px auto 0;border-radius:2px;
    }
    .question-box{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-width:820px;
      margin:40px auto;
      padding:28px 30px;
      text-align:left;
    }
    .header-row{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px;
    }
    #user-name{
      flex:1; min-width:220px;
      padding:12px;font-size:16px;border:1px solid #ccc;border-radius:6px;
      transition:border-color .3s;
    }
    #user-name:focus{border-color:var(--primary);outline:none}
    .progress{
      font-size:14px;color:var(--muted);
      margin-left:auto
    }
    .question-title{
      font-size:21px;font-weight:600;color:var(--text);margin:18px 0 8px;
    }
    .question-sub{
      font-size:14px;color:var(--muted);margin:4px 0 16px;
    }
    .options{display:flex;flex-direction:column;gap:10px;margin:10px 0 12px}
    .opt{
      display:flex;align-items:flex-start;gap:10px;
      padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;
      transition:background .2s,border-color .2s;
    }
    .opt:hover{background:#f8fafc;border-color:#d1d5db}
    .opt input{margin-top:3px}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .img-wrap{margin:18px 0;text-align:center}
    .img-wrap img{
      display:block;margin:0 auto;max-width:100%;border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1)
    }
    .button-box{margin-top:22px;display:flex;gap:10px;justify-content:center}
    button{
      background-color:var(--primary);color:#fff;font-size:16px;border:none;border-radius:30px;
      padding:12px 24px;cursor:pointer;box-shadow:0 4px 10px rgba(0,123,255,0.2);
      transition:background-color .3s ease, transform .1s ease;
    }
    button:hover{background-color:var(--primary-dark);transform:translateY(-1px)}
    button.secondary{background:#e5e7eb;color:#111;box-shadow:none}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none !important}
    .matrix{width:100%;border-collapse:collapse;margin-top:8px}
    .matrix th,.matrix td{border:1px solid #e5e7eb;padding:8px;text-align:center}
    .matrix th{background:#f8fafc;font-weight:600}
    .pill{
      display:inline-block;background:#eef6fd;color:#2468a2;border:1px solid #cde4fb;
      padding:2px 10px;border-radius:999px;font-size:12px;margin-left:8px
    }
    .notice{
      background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;
      padding:10px 12px;color:#334155;font-size:14px;margin:10px 0
    }
    .rank-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
    .rank-item{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:grab}
    .rank-item.dragging{opacity:.6}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="title-box">Questionario Competenze Digitali</div>

  <div class="question-box" id="app">
    <div class="header-row">
      <input type="text" id="user-name" placeholder="Inserisci il tuo nome (richiesto)"/>
      <div class="progress" id="progress">Domanda 1 di â€¦</div>
    </div>

    <div id="q-wrap">
      <!-- Qui viene renderizzata la domanda corrente -->
    </div>

    <div class="button-box">
      <button class="secondary" id="backBtn" disabled>Indietro</button>
      <button id="nextBtn">Avanti</button>
    </div>

    <div class="muted" id="helper"></div>
  </div>

  <script>
    /***********************
     * CONFIG SUPABASE
     ***********************/
    const SUPABASE_URL = 'https://lteztcnhpkleuvqeaphq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0ZXp0Y25ocGtsZXV2cWVhcGhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MzE5MjYsImV4cCI6MjA2ODUwNzkyNn0.Wbvy9R5kVYRAjxzhbxK4d76ctqAT-ZyX4kaL7nqGFnc';

    async function salvaRispostaSupabase(payload) {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/Risposte`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const t = await res.text();
          console.error('Errore Supabase:', t);
          alert("Errore Supabase: " + t);
        }
      } catch (e) {
        console.error(e);
        alert("Errore di rete: " + e.message);
      }
    }

    /***********************
     * MODELLI DOMANDE
     ***********************/
    // Tipi: single, multi, matrix, rank, text
    // Per quesiti "conoscitivi" si puÃ² valorizzare "correct" (string) per il confronto.
    // Ogni elemento puÃ² avere "image" (percorso/URL) mostrato sotto al testo.

    const Q = [];

    // ====== BLOCCO: DISPOSITIVI ======
    Q.push(
      {
        id:'disp_accesso',
        section:'DISPOSITIVI',
        text:'Hai accesso a un dispositivo digitale (smartphone, computer o tablet) che usi personalmente?',
        type:'single',
        required:true,
        options:['SÃ¬','No'],
        image:'www/mucca.jpg'
      },
      // --- ramo NO
      {
        id:'disp_no_bisogni',
        showIf:{id:'disp_accesso', equals:'No'},
        section:'DISPOSITIVI',
        text:'Di cosa avresti bisogno per imparare a usare un dispositivo digitale? (Risposta multipla)',
        type:'multi',
        options:['Avere un dispositivo personale','Pratica e dedizione','Interesse e iniziativa','Memoria e concentrazione'],
        image:'img/learning_needs.jpg'
      },
      {
        id:'disp_no_difficolta',
        showIf:{id:'disp_accesso', equals:'No'},
        section:'DISPOSITIVI',
        text:'Quali difficoltÃ  incontri (o pensi potresti incontrare) nellâ€™imparare a usare un dispositivo digitale? (Risposta multipla)',
        type:'multi',
        options:['DifficoltÃ  pratiche','DifficoltÃ  di lettura e scrittura','Memoria e agilitÃ  mentale','Paura del dispositivo o timore di romperlo'],
        image:'img/difficulties.jpg'
      },
      {
        id:'disp_no_aiuti',
        showIf:{id:'disp_accesso', equals:'No'},
        section:'DISPOSITIVI',
        text:'Cosa pensi potrebbe aiutarti di piÃ¹ ad imparare a usare un dispositivo digitale? (Risposta multipla)',
        type:'multi',
        options:['Avere piÃ¹ tempo per fare pratica','Ricevere spiegazioni semplici e chiare','Avere qualcuno che ti supporta e ti guida','Ripetere spesso le stesse operazioni fino a sentirti sicuro'],
        image:'img/help_learn.jpg'
      },
      // --- ramo SI
      {
        id:'disp_si_tempo',
        showIf:{id:'disp_accesso', equals:'SÃ¬'},
        section:'DISPOSITIVI',
        text:'Da quanto tempo utilizzi regolarmente dispositivi digitali (smartphone, tablet o computer)?',
        type:'single',
        options:['Meno di 1 anno','Da 1 a 3 anni','Da 3 a 5 anni','PiÃ¹ di 5 anni'],
        image:'img/usage_time.jpg'
      },
      {
        id:'disp_si_tipologia',
        showIf:{id:'disp_accesso', equals:'SÃ¬'},
        section:'DISPOSITIVI',
        text:'Quali dei seguenti dispositivi possiedi o a quali hai accesso? (Scelta multipla)',
        type:'multi',
        options:['Computer fisso o portatile','Tablet / iPad','eReader (es. Kindle)','Console videogiochi con accesso Internet','Smart TV','Smartphone','Altro (specificare)'],
        allowOther:true,
        image:'img/devices_list.jpg'
      },
      // Per ogni dispositivo selezionato chiediamo 3 sotto-domande (matrice ripetuta)
      {
        id:'disp_meta_perdevice',
        showIf:{id:'disp_si_tipologia', inSelected:[
          'Computer fisso o portatile','Tablet / iPad','eReader (es. Kindle)','Console videogiochi con accesso Internet','Smart TV','Smartphone','Altro (specificare)'
        ]},
        section:'DISPOSITIVI',
        text:'Per ciascun dispositivo selezionato, rispondi:',
        type:'matrixPerItem',
        perItemSource:'disp_si_tipologia',
        columns:[
          {key:'tempo', label:'Da quanto tempo lo utilizzi?', choices:['Meno di 1 anno','1-3 anni','3-5 anni','PiÃ¹ di 5 anni']},
          {key:'agio', label:'Quanto ti senti a tuo agio nellâ€™utilizzarlo?', choices:['Per niente','Poco','Abbastanza','Molto','Completamente a mio agio']},
          {key:'frequenza', label:'Con quale frequenza lo usi?', choices:['Spesso','Occasionalmente','Mai']}
        ],
        image:'img/per_device.jpg'
      },
      // Domande aggiuntive per Smartphone/Tablet
      {
        id:'disp_smart_activities',
        showIfAny:[
          {id:'disp_si_tipologia', includes:'Smartphone'},
          {id:'disp_si_tipologia', includes:'Tablet / iPad'}
        ],
        section:'DISPOSITIVI',
        text:'(Smartphone/Tablet) Quali sono le principali attivitÃ  che svolgi con questo dispositivo? (Risposta multipla)',
        type:'multi',
        options:['Chiamate e messaggi','Social network','Giochi','Video / streaming','Navigazione internet','Lavoro / studio','Fotografia e video','Altro (specificare)'],
        allowOther:true,
        image:'img/smartphone_tablet.jpg'
      },
      {
        id:'disp_t9',
        showIfAny:[
          {id:'disp_si_tipologia', includes:'Smartphone'},
          {id:'disp_si_tipologia', includes:'Tablet / iPad'}
        ],
        section:'DISPOSITIVI',
        text:'Che cosâ€™Ã¨ il T9 nei telefoni cellulari?',
        type:'single',
        options:[
          'Un sistema di scrittura predittiva che suggerisce le parole mentre digiti',
          'Un modello di smartphone di nuova generazione',
          'Unâ€™app per la messaggistica istantanea',
          'Un formato di file per immagini',
          'Non lo so'
        ],
        correct:'Un sistema di scrittura predittiva che suggerisce le parole mentre digiti',
        image:'img/t9.jpg'
      },
      // Domande aggiuntive per Computer
      {
        id:'pc_chi_insegna',
        showIf:{id:'disp_si_tipologia', includes:'Computer fisso o portatile'},
        section:'DISPOSITIVI',
        text:'(Computer) Chi ti ha insegnato ad utilizzare il computer?',
        type:'multi',
        options:['insegnante','famiglia','libri','autodidatta','colleghi','amici','tutorial online','altri'],
        image:'img/pc_teacher.jpg'
      },
      {
        id:'pc_per_cosa',
        showIf:{id:'disp_si_tipologia', includes:'Computer fisso o portatile'},
        section:'DISPOSITIVI',
        text:'(Computer) Per cosa lo utilizzi?',
        type:'matrix',
        rows:['Lavoro','Studio','Navigazione internet','Gaming','Grafica / montaggio video','Programmazione / sviluppo software','Altro (specificare)'],
        rowOther:true,
        columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai'],
        image:'img/pc_usage.jpg'
      },
      {
        id:'pc_app_frequenti',
        showIf:{id:'disp_si_tipologia', includes:'Computer fisso o portatile'},
        section:'DISPOSITIVI',
        text:'(Computer) Quali app usi piÃ¹ frequentemente? (Risposta multipla)',
        type:'multi',
        options:['Suite Office (Word, Excel, ecc.)','App per videoconferenze (Zoom, Teams, Meet, ecc.)','App per note e organizzazione (Evernote, Notion, ecc.)','App per gestione di progetti','Altro (specificare)'],
        allowOther:true,
        image:'img/pc_apps.jpg'
      },
      {
        id:'pc_suite_which',
        showIf:{id:'pc_app_frequenti', includes:'Suite Office (Word, Excel, ecc.)'},
        section:'DISPOSITIVI',
        text:'(Suite Office) Quale programma della Suite Office utilizzi di piÃ¹? (Scelta multipla)',
        type:'multi',
        options:['Microsoft Word','Microsoft Excel','Microsoft PowerPoint','Microsoft OneNote','Altro (specificare)'],
        allowOther:true,
        image:'img/office_suite.jpg'
      },
      {
        id:'pc_suite_use',
        showIf:{id:'pc_app_frequenti', includes:'Suite Office (Word, Excel, ecc.)'},
        section:'DISPOSITIVI',
        text:'Per quali attivitÃ  utilizzi la Suite Office? (Scelte multiple)',
        type:'multi',
        options:[
          'Scrivere documenti o relazioni',
          'Creare fogli di calcolo e grafici',
          'Preparare presentazioni',
          'Collaborare in tempo reale con altre persone',
          'Organizzare attivitÃ  domestiche (es. lista della spesa, gestione budget familiare)',
          'Lavoro dâ€™ufficio',
          'Altro (specificare)'
        ],
        allowOther:true,
        image:'img/office_tasks.jpg'
      },
      // Domande aggiuntive per Smart TV
      {
        id:'tv_cosa_guardi',
        showIf:{id:'disp_si_tipologia', includes:'Smart TV'},
        section:'DISPOSITIVI',
        text:'(Smart TV) Cosa guardi principalmente? (Risposta multipla)',
        type:'multi',
        options:[
          'Canali televisivi tradizionali',
          'Piattaforme di streaming (Netflix, Prime Video, Disney+, ecc.)',
          'YouTube o simili',
          'Servizi on demand delle emittenti TV',
          'Altro (specificare)'
        ],
        allowOther:true,
        image:'img/smart_tv.jpg'
      },
      {
        id:'tv_quanto_spesso',
        showIf:{id:'disp_si_tipologia', includes:'Smart TV'},
        section:'DISPOSITIVI',
        text:'(Smart TV) Quanto spesso utilizzi le funzioni â€œsmartâ€ della TV?',
        type:'single',
        options:['Quasi sempre','Spesso','Occasionalmente','Raramente','Mai'],
        image:'img/smart_tv_use.jpg'
      }
    );

    // ====== BLOCCO: INTERNET ======
    Q.push(
      {
        id:'net_conn',
        section:'INTERNET',
        text:'Tramite quale connessione accedi a Internet? (Scelta multipla)',
        type:'multi',
        options:['Wi-Fi di casa','Rete mobile (4G/5G)','Wi-Fi pubblico','Non utilizzo Internet'],
        image:'img/internet_conn.jpg'
      },
      // Se "Non utilizzo Internet" Ã¨ selezionato, le sotto-domande internet si saltano.
      {
        id:'net_acquisti_3m',
        showIfNotSelected:{id:'net_conn', value:'Non utilizzo Internet'},
        section:'INTERNET',
        text:'Negli ultimi 3 mesi hai utilizzato Internet per acquistare beni o servizi?',
        type:'single',
        options:['SÃ¬','No'],
        image:'img/ecommerce.jpg'
      },
      {
        id:'net_acquisti_freq',
        showIf:{id:'net_acquisti_3m', equals:'SÃ¬'},
        section:'INTERNET',
        text:'Per cosa hai usato Internet negli acquisti? (Frequenza per ciascuna voce)',
        type:'matrix',
        rows:[
          'Acquistare articoli fisici (abbigliamento, elettronica, libri, ecc.)',
          'Ordinare generi alimentari o fare la spesa online',
          'Prenotare viaggi, biglietti o alloggi',
          'Pagare bollette o tasse online',
          'Ottenere coupon o sconti digitali',
          'Comprare o vendere su marketplace (Amazon, eBay, Zalando)',
          'Comprare o vendere su siti di annunci (Subito.it, Vinted)'
        ],
        columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai'],
        image:'img/ecommerce_matrix.jpg'
      },
      {
        id:'net_comms_3m',
        showIfNotSelected:{id:'net_conn', value:'Non utilizzo Internet'},
        section:'INTERNET',
        text:'Negli ultimi 3 mesi hai utilizzato Internet per comunicare con altre persone?',
        type:'single',
        options:['SÃ¬','No'],
        image:'img/communication.jpg'
      },
      {
        id:'net_comms_channels',
        showIf:{id:'net_comms_3m', equals:'SÃ¬'},
        section:'INTERNET',
        text:'Quali canali hai usato?',
        type:'multi',
        options:[
          'Inviare o leggere e-mail',
          'Fare videochiamate (Skype, Facetime, WhatsApp video)',
          'Chattare su servizi di messaggistica istantanea (WhatsApp, Telegram, Messenger)',
          'Usare social network per comunicare (Facebook, Instagram, LinkedIn)'
        ],
        image:'img/channels.jpg'
      },
      {
        id:'net_info_3m',
        showIfNotSelected:{id:'net_conn', value:'Non utilizzo Internet'},
        section:'INTERNET',
        text:'Negli ultimi 3 mesi hai utilizzato Internet per informarti o cercare contenuti?',
        type:'single',
        options:['SÃ¬','No'],
        image:'img/information.jpg'
      },
      {
        id:'net_info_types',
        showIf:{id:'net_info_3m', equals:'SÃ¬'},
        section:'INTERNET',
        text:'Quali tipi di contenuti hai cercato? (Frequenza per ciascuna voce)',
        type:'matrix',
        rows:[
          'Leggere notizie o articoli di attualitÃ ',
          'Cercare informazioni su salute e assistenza sanitaria',
          'Guardare film, programmi TV o video in streaming',
          'Fare ricerche su Wikipedia o siti simili',
          'Cercare informazioni su hobby o interessi personali (ricette, giardinaggio, bricolage, ecc.)',
          'Cercare indicazioni stradali o mappe',
          'Seguire i mercati finanziari'
        ],
        columns:['Giornalmente','3-4 volte a settimana','1-2 volte a settimana','1-2 volte al mese','Raramente','Mai'],
        image:'img/content_types.jpg'
      },
      {
        id:'net_pubserv_3m',
        showIfNotSelected:{id:'net_conn', value:'Non utilizzo Internet'},
        section:'INTERNET',
        text:'Negli ultimi 3 mesi hai utilizzato Internet per servizi pubblici?',
        type:'single',
        options:['SÃ¬','No'],
        image:'img/public_services.jpg'
      },
      {
        id:'net_pubserv_how',
        showIf:{id:'net_pubserv_3m', equals:'SÃ¬'},
        section:'INTERNET',
        text:'In che modo?',
        type:'multi',
        options:[
          'Prenotare visite mediche online',
          'Accedere a servizi pubblici digitali (SPID, CIE, Fascicolo Sanitario, Agenzia delle Entrate, INPS)',
          'altro'
        ],
        image:'img/public_services_how.jpg'
      }
    );

    // ====== BLOCCO: LAVORO ======
    Q.push(
      {
        id:'job_now',
        section:'LAVORO',
        text:'Attualmente svolgi attivitÃ  lavorativa?',
        type:'single',
        options:['SÃ¬','No'],
        image:'img/work.jpg'
      },
      {
        id:'job_yn_list',
        showIf:{id:'job_now', equals:'SÃ¬'},
        section:'LAVORO',
        text:'(Se lavori) Rispondi SÃ¬/No alle seguenti domande:',
        type:'ynList',
        items:[
          'Hai mai utilizzato computer o Internet per lavoro?',
          'Hai inviato candidature online negli ultimi 12 mesi?',
          'Hai partecipato a corsi di formazione online negli ultimi 12 mesi?',
          'Hai partecipato a riunioni online negli ultimi 12 mesi?',
          'Hai mai utilizzato strumenti di condivisione file (Google Drive, Dropbox)?',
          'Lavori o hai lavorato mai in smart working?'
        ],
        image:'img/work_yesno.jpg'
      },
      {
        id:'job_skills_matrix',
        showIf:{id:'job_now', equals:'SÃ¬'},
        section:'LAVORO',
        text:'Come valuteresti le tue competenze informatiche nel lavoro?',
        type:'matrix',
        rows:[
          'Applicazioni di videoscrittura (es. Word)',
          'Applicazioni di fogli di calcolo (es. Excel)',
          'Applicazioni per database',
          'Applicazioni per presentazioni (es. PowerPoint)',
          'Applicazioni multimediali (audio, video, immagini)',
          'Applicazioni per la progettazione di siti web',
          'Motori di ricerca sul web (es. Google)',
          'Applicazioni di comunicazione (es. email, videoconferenze)'
        ],
        columns:['Nessuna','Base','Intermedia','Avanzata'],
        image:'img/work_skills.jpg'
      }
    );

    // ====== BLOCCO: SICUREZZA ======
    Q.push(
      {
        id:'sec_precauzioni',
        section:'SICUREZZA',
        text:'Solitamente prendi precauzioni per proteggere i tuoi dati online?',
        type:'single',
        options:['SÃ¬','No'],
        image:'img/security.jpg'
      },
      {
        id:'sec_pratiche',
        showIf:{id:'sec_precauzioni', equals:'SÃ¬'},
        section:'SICUREZZA',
        text:'Se SÃ¬: seleziona le pratiche che adotti (SÃ¬/No per ciascuna).',
        type:'ynList',
        items:[
          'Utilizzi password complesse e diverse?',
          'Cambi regolarmente le password?',
          'Hai mai installato e/o aggiornato un antivirus?',
          'Controlli solitamente le impostazioni di privacy sui social?'
        ],
        image:'img/security_habits.jpg'
      },
      {
        id:'sec_password_order',
        section:'SICUREZZA',
        text:'Ordina queste password dalla piÃ¹ sicura (1) alla meno sicura (4).',
        type:'rank',
        rankItems:[
          'Tr*9kLm!28#q',
          'P4ssw0rd!',
          'Maria1970',
          '12345678'
        ],
        image:'img/passwords.jpg'
      }
    );

    // ====== BLOCCO: ICONE / CONOSCENZE ======
    Q.push(
      {
        id:'ico_lock',
        section:'ICONE',
        text:'(icona lucchetto) Quando compare questo simbolo vicino allâ€™indirizzo di un sito web, cosa significa?',
        type:'single',
        options:[
          'A. La connessione tra il tuo dispositivo e il sito Ã¨ sicura',
          'B. Il sito Ã¨ stato visitato di recente',
          'C. Il sito Ã¨ a pagamento',
          'D. Il sito non funziona senza password'
        ],
        correct:'A. La connessione tra il tuo dispositivo e il sito Ã¨ sicura',
        image:'img/icon_lock.png'
      },
      {
        id:'ico_gear',
        section:'ICONE',
        text:'(icona ingranaggio) Cosa permette di fare questa icona sullo smartphone o computer?',
        type:'single',
        options:[
          'A. Aprire il menu delle impostazioni',
          'B. Avviare la fotocamera',
          'C. Spegnere il dispositivo',
          'D. Aggiornare unâ€™applicazione'
        ],
        correct:'A. Aprire il menu delle impostazioni',
        image:'img/icon_gear.png'
      },
      {
        id:'ico_mail',
        section:'ICONE',
        text:'(icona busta da lettera) Cosa rappresenta solitamente questa icona?',
        type:'single',
        options:[
          'A. Email o messaggi',
          'B. Rubrica dei contatti',
          'C. Lista degli appuntamenti',
          'D. Documenti salvati'
        ],
        correct:'A. Email o messaggi',
        image:'img/icon_mail.png'
      },
      {
        id:'ico_wifi',
        section:'ICONE',
        text:'(icona Wi-Fi) Quando questa icona Ã¨ piena e luminosa, cosa indica?',
        type:'single',
        options:[
          'A. Sei connesso a Internet tramite rete wireless',
          'B. Il dispositivo sta scaricando dati',
          'C. Ãˆ attiva la connessione Bluetooth',
          'D. Stai guardando un video in streaming'
        ],
        correct:'A. Sei connesso a Internet tramite rete wireless',
        image:'img/icon_wifi.png'
      },
      {
        id:'ico_bt',
        section:'ICONE',
        text:'(icona Bluetooth) A cosa serve questa funzione su smartphone, tablet o computer?',
        type:'single',
        options:[
          'A. Collegare dispositivi senza fili (cuffie, casse, tastiere)',
          'B. Navigare in Internet ad alta velocitÃ ',
          'C. Bloccare lâ€™accesso al dispositivo',
          'D. Salvare file nella memoria interna'
        ],
        correct:'A. Collegare dispositivi senza fili (cuffie, casse, tastiere)',
        image:'img/icon_bluetooth.png'
      },
      {
        id:'ico_qr',
        section:'ICONE',
        text:'(immagine di QR code) Cosa puoi fare con questo tipo di codice?',
        type:'single',
        options:[
          'A. Scansionarlo per aprire un link, ottenere informazioni o accedere a un servizio',
          'B. Usarlo per aumentare la velocitÃ  di connessione Internet',
          'C. Inserirlo come password per accedere al computer',
          'D. Stamparlo per decorare un documento'
        ],
        correct:'A. Scansionarlo per aprire un link, ottenere informazioni o accedere a un servizio',
        image:'img/icon_qr.png'
      },
      {
        id:'ico_cpu',
        section:'ICONE',
        text:'Qual Ã¨ il â€œcervello principaleâ€ del computer?',
        type:'single',
        options:['CPU','LAN','RAM','ROM'],
        correct:'CPU',
        image:'img/cpu.jpg'
      }
    );

    // ====== BLOCCO: FINALI (Likert) ======
    Q.push(
      {
        id:'final_likert',
        section:'FINALE',
        text:'Indica in che misura sei dâ€™accordo con le seguenti affermazioni.',
        type:'matrix',
        rows:[
          'Mi piace usare i dispositivi digitali.',
          'Mi sento a mio agio nellâ€™utilizzarli.',
          'Sono disposto/a a imparare nuove funzioni dei dispositivi digitali.',
          'Penso che i dispositivi digitali siano complicati da usare.',
          'Mi sento in difficoltÃ  quando altre persone parlano di tecnologia digitale.',
          'Credo che sia importante per me imparare a usare meglio i dispositivi digitali.',
          'Mi piacerebbe usare piÃ¹ spesso i dispositivi digitali nella vita quotidiana.',
          'Penso che i dispositivi digitali possano rendere piÃ¹ semplici alcune attivitÃ  (es. viaggiare, pagare bollette, cercare informazioni).',
          'Credo che dovrebbero esistere piÃ¹ corsi o iniziative di formazione per aiutare persone della mia etÃ  a usare i dispositivi digitali.'
        ],
        columns:['Fortemente dâ€™accordo','Dâ€™accordo','Indeciso','In disaccordo','Fortemente in disaccordo'],
        image:'img/likert.jpg'
      }
    );

    /***********************
     * STATO & NAVIGAZIONE
     ***********************/
    const state = {
      index: 0,
      answers: {}, // id -> value
      history: [], // stack di indici visitati per "Indietro"
    };

    function visibleQuestions(){
      // Filtra Q per le condizioni showIf / showIfAny / showIfNotSelected / inSelected / includes
      const ans = state.answers;
      return Q.filter(q=>{
        if(q.showIf){
          const v = ans[q.showIf.id];
          if(q.showIf.equals!==undefined && v !== q.showIf.equals) return false;
          if(q.showIf.includes!==undefined){
            const vv = ans[q.showIf.id] || [];
            if(!Array.isArray(vv) || !vv.includes(q.showIf.includes)) return false;
          }
        }
        if(q.showIfAny){
          const ok = q.showIfAny.some(cond=>{
            const v = ans[cond.id];
            if(cond.equals!==undefined) return v===cond.equals;
            if(cond.includes!==undefined){
              const vv = ans[cond.id] || [];
              return Array.isArray(vv) && vv.includes(cond.includes);
            }
            return false;
          });
          if(!ok) return false;
        }
        if(q.showIfNotSelected){
          const v = ans[q.showIfNotSelected.id] || [];
          if(Array.isArray(v) && v.includes(q.showIfNotSelected.value)) return false;
        }
        if(q.inSelected){
          const v = ans[q.inSelected.id] || [];
          const needed = q.inSelected.values || [];
          if(!Array.isArray(v) || !needed.every(x=>v.includes(x))) return false;
        }
        if(q.perItemSource){
          // handled at render time
        }
        return true;
      });
    }

    function updateProgress(){
      const V = visibleQuestions();
      const pos = Math.min(state.index+1, V.length);
      $('#progress').text(`Domanda ${pos} di ${V.length}`);
      $('#backBtn').prop('disabled', state.history.length===0);
    }

    function renderCurrent(){
      const V = visibleQuestions();
      if(state.index>=V.length){
        // Fine questionario
        $('#q-wrap').html(`
          <div class="question-title">Questionario completato! ðŸŽ‰</div>
          <p class="question-sub">Grazie per aver partecipato.</p>
          <div class="notice">Le risposte sono state inviate a Supabase man mano che avanzavi.</div>
        `);
        $('#nextBtn').addClass('hidden');
        $('#backBtn').addClass('hidden');
        updateProgress();
        return;
      }
      const q = V[state.index];
      const name = $('#user-name').val().trim();
      const imgHtml = q.image ? `<div class="img-wrap"><img id="question-image" src="${q.image}" alt="Immagine associata alla domanda"/></div>` : '';

      let content = `<div class="pill">${q.section}</div><div class="question-title">${q.text}</div>${imgHtml}`;

      const val = state.answers[q.id];

      if(q.type==='single'){
        content += `<div class="options">` + q.options.map((op,i)=>{
          const id=`${q.id}_opt_${i}`;
          const checked = val===op ? 'checked' : '';
          return `<label class="opt" for="${id}">
              <input type="radio" id="${id}" name="${q.id}" value="${op}" ${checked} />
              <span>${op}</span>
            </label>`;
        }).join('') + `</div>`;
      }

      if(q.type==='multi'){
        content += `<div class="options">` + q.options.map((op,i)=>{
          const id=`${q.id}_chk_${i}`;
          const checked = Array.isArray(val) && val.includes(op) ? 'checked' : '';
          return `<label class="opt" for="${id}">
              <input type="checkbox" id="${id}" name="${q.id}" value="${op}" ${checked} />
              <span>${op}</span>
            </label>`;
        }).join('') + `</div>`;
        if(q.allowOther){
          const otherVal = (Array.isArray(val) && val.find(v=>v.startsWith('Altro: '))) ? val.find(v=>v.startsWith('Altro: ')).replace('Altro: ','') : '';
          content += `
            <div class="opt">
              <input type="checkbox" id="${q.id}_other_chk" ${otherVal ? 'checked':''} />
              <label for="${q.id}_other_chk" style="flex:1">Altro (specificare)</label>
            </div>
            <input type="text" id="${q.id}_other_txt" placeholder="Specifica..." value="${otherVal||''}" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-top:6px"/>
          `;
        }
      }

      if(q.type==='matrix'){
        content += `<table class="matrix"><thead><tr><th>Voce</th>` +
          q.columns.map(c=>`<th>${c}</th>`).join('') +
          `</tr></thead><tbody>` +
          q.rows.map((r,ri)=>{
            const rowOther = q.rowOther && r==='Altro (specificare)';
            let otherInput = '';
            const baseId=`${q.id}_r${ri}`;
            const rowVal = (val && val[r]) || null;
            if(rowOther){
              const otherTxt = (val && val.__otherText) || '';
              otherInput = `<div style="margin-top:6px"><input type="text" id="${q.id}_other" placeholder="Specifica..." value="${otherTxt}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/></div>`;
            }
            return `<tr><td style="text-align:left">${r}${rowOther?otherInput:''}</td>` +
              q.columns.map((c,ci)=>{
                const id=`${baseId}_c${ci}`;
                const checked = rowVal===c ? 'checked':'';
                return `<td><input type="radio" name="${baseId}" id="${id}" value="${c}" ${checked} aria-label="${r} - ${c}"/></td>`;
              }).join('') +
            `</tr>`;
          }).join('') + `</tbody></table>
          <div class="question-sub">Seleziona una risposta per ciascuna riga.</div>`;
      }

      if(q.type==='matrixPerItem'){
        // Per ciascun item dalla selezione precedente
        const items = (state.answers[q.perItemSource] || []).slice();
        content += `<table class="matrix"><thead><tr><th>Dispositivo</th>` +
          q.columns.map(c=>`<th>${c.label}</th>`).join('') +
          `</tr></thead><tbody>` +
          items.map((item,ri)=>{
            const base=`${q.id}_${ri}`;
            const rowVal = (val && val[item]) || {};
            return `<tr>
              <td style="text-align:left">${item}</td>
              ${q.columns.map((col,ci)=>{
                const name = `${base}_${col.key}`;
                const current = rowVal[col.key] || '';
                return `<td>
                  <select id="${name}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px">
                    <option value="">â€”</option>
                    ${col.choices.map(choice=>`<option value="${choice}" ${current===choice?'selected':''}>${choice}</option>`).join('')}
                  </select>
                </td>`;
              }).join('')}
            </tr>`;
          }).join('') + `</tbody></table>
          <div class="question-sub">Compila le colonne per ogni dispositivo selezionato.</div>`;
      }

      if(q.type==='ynList'){
        content += `<div class="options">` + q.items.map((it,idx)=>{
          const idBase = `${q.id}_${idx}`;
          const current = (val && val[it]) || '';
          return `<div class="grid-2">
            <div class="opt" style="border:none;padding:0"><strong>${it}</strong></div>
            <div class="opt" style="justify-content:space-between">
              <label><input type="radio" name="${idBase}" value="SÃ¬" ${current==='SÃ¬'?'checked':''}/> SÃ¬</label>
              <label><input type="radio" name="${idBase}" value="No" ${current==='No'?'checked':''}/> No</label>
            </div>
          </div>`;
        }).join('') + `</div>`;
      }

      if(q.type==='rank'){
        const items = val && Array.isArray(val) ? val : q.rankItems.slice();
        content += `
          <div class="question-sub">Trascina per ordinare dallâ€™alto (1 = piÃ¹ sicura) al basso (4 = meno sicura).</div>
          <ul class="rank-list" id="${q.id}_rank">
            ${items.map((it,i)=>`<li class="rank-item" draggable="true" data-val="${it}">${i+1}) ${it}</li>`).join('')}
          </ul>
        `;
      }

      $('#q-wrap').html(content);
      attachRankDnD(q);
      updateProgress();
      $('#helper').text('');
    }

    function attachRankDnD(q){
      if(q.type!=='rank') return;
      const ul = document.getElementById(`${q.id}_rank`);
      let draggingEl = null;

      ul.querySelectorAll('.rank-item').forEach(li=>{
        li.addEventListener('dragstart', e=>{
          draggingEl = li;
          li.classList.add('dragging');
        });
        li.addEventListener('dragend', e=>{
          li.classList.remove('dragging');
          // aggiorna numeri
          Array.from(ul.children).forEach((el,idx)=>{ el.textContent = `${idx+1}) ${el.getAttribute('data-val')}`; });
        });
      });
      ul.addEventListener('dragover', e=>{
        e.preventDefault();
        const afterElement = getDragAfterElement(ul, e.clientY);
        if(afterElement==null){
          ul.appendChild(draggingEl);
        }else{
          ul.insertBefore(draggingEl, afterElement);
        }
      });
      function getDragAfterElement(container, y){
        const els = [...container.querySelectorAll('.rank-item:not(.dragging)')];
        return els.reduce((closest, child)=>{
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if(offset < 0 && offset > closest.offset){
            return {offset, element:child};
          } else {
            return closest;
          }
        }, {offset:Number.NEGATIVE_INFINITY}).element;
      }
    }

    function readAnswer(q){
      if(q.type==='single'){
        const v = $(`input[name="${q.id}"]:checked`).val();
        return v || null;
      }
      if(q.type==='multi'){
        const arr = Array.from($(`input[name="${q.id}"]:checked`)).map(x=>x.value);
        const otherChk = $(`#${q.id}_other_chk`).prop('checked');
        const otherTxt = ($(`#${q.id}_other_txt`).val()||'').trim();
        if(otherChk && otherTxt) arr.push('Altro: ' + otherTxt);
        return arr.length ? arr : null;
      }
      if(q.type==='matrix'){
        const result = {};
        let complete = true;
        q.rows.forEach((r,ri)=>{
          // altrove
          if(q.rowOther && r==='Altro (specificare)'){
            const other = $(`#${q.id}_other`).val() || '';
            if(other) result.__otherText = other;
          }
          const name = `${q.id}_r${ri}`;
          const v = $(`input[name="${name}"]:checked`).val();
          if(v) result[r] = v;
          else complete = false;
        });
        return complete ? result : null;
      }
      if(q.type==='matrixPerItem'){
        const items = (state.answers[q.perItemSource] || []);
        const res = {};
        let ok = true;
        items.forEach((item,i)=>{
          res[item] = {};
          q.columns.forEach(col=>{
            const val = $(`#${q.id}_${i}_${col.key}`).val();
            if(!val) ok = false;
            res[item][col.key] = val || '';
          });
        });
        return ok ? res : null;
      }
      if(q.type==='ynList'){
        const res = {};
        let ok = true;
        q.items.forEach((it,idx)=>{
          const name = `${q.id}_${idx}`;
          const v = $(`input[name="${name}"]:checked`).val();
          if(!v) ok = false;
          res[it] = v || '';
        });
        return ok ? res : null;
      }
      if(q.type==='rank'){
        const arr = Array.from(document.querySelectorAll(`#${q.id}_rank .rank-item`)).map(li=>li.getAttribute('data-val'));
        return arr.length ? arr : null;
      }
      return null;
    }

    function isSkippable(q){
      // se q Ã¨ condizionato e la condizione non Ã¨ soddisfatta, non viene nemmeno renderizzato (giÃ  filtrato)
      return false;
    }

    function validateAndSave(){
      const V = visibleQuestions();
      const q = V[state.index];

      // nome richiesto
      const nome = ($('#user-name').val()||'').trim();
      if(!nome){
        $('#helper').text('Inserisci il tuo nome per continuare.');
        $('#user-name').focus();
        return false;
      }

      const ans = readAnswer(q);
      if(!ans){
        $('#helper').text('Per favore rispondi alla domanda prima di procedere.');
        return false;
      }

      state.answers[q.id] = ans;

      // Salvataggio su Supabase (uno o piÃ¹ record a seconda del tipo)
      const saveRows = [];

      const basePayload = (domanda, risposta, correct=null) => {
        // esito
        let esito = 'n/a';
        if(correct!==null){
          if(Array.isArray(risposta)){
            // in questo questionario non abbiamo multi con correct, ma gestiamo comunque
            const ok = risposta.sort().join('||') === (Array.isArray(correct)?correct.sort().join('||'):String(correct));
            esito = ok ? 'corretto' : 'sbagliato';
          } else {
            esito = (String(risposta) === String(correct)) ? 'corretto' : 'sbagliato';
          }
        }
        return {
          nome,
          domanda,
          risposta: (typeof risposta === 'string') ? risposta : JSON.stringify(risposta),
          corretto: correct,
          esito
        };
      };

      if(q.type==='single'){
        saveRows.push(basePayload(q.text, ans, q.correct ?? null));
      }
      if(q.type==='multi'){
        saveRows.push(basePayload(q.text, ans.join('; '), q.correct ?? null));
      }
      if(q.type==='matrix'){
        // una riga per ciascuna voce
        Object.entries(ans).forEach(([k,v])=>{
          if(k==='__otherText') return;
          const dom = `${q.text} - ${k}`;
          saveRows.push(basePayload(dom, v, null));
        });
        if(ans.__otherText){
          const dom = `${q.text} - Specifica (Altro)`;
          saveRows.push(basePayload(dom, ans.__otherText, null));
        }
      }
      if(q.type==='matrixPerItem'){
        Object.entries(ans).forEach(([item,obj])=>{
          Object.entries(obj).forEach(([colKey,val])=>{
            const colLabel = (q.columns.find(c=>c.key===colKey)||{}).label || colKey;
            const dom = `${q.text} - ${item} / ${colLabel}`;
            saveRows.push(basePayload(dom, val, null));
          });
        });
      }
      if(q.type==='ynList'){
        Object.entries(ans).forEach(([k,v])=>{
          const dom = `${q.text} - ${k}`;
          saveRows.push(basePayload(dom, v, null));
        });
      }
      if(q.type==='rank'){
        // salvo lâ€™ordine come stringa numerata
        const ordered = ans.map((x,i)=>`${i+1}) ${x}`).join(' | ');
        // opzionale: calcolo "corretto" per la sicurezza? Non richiesto, quindi null.
        saveRows.push(basePayload(q.text, ordered, null));
      }

      // invia in sequenza (per semplicitÃ  e compatibilitÃ  con la tua tabella)
      (async ()=>{
        for(const row of saveRows){
          await salvaRispostaSupabase(row);
        }
      })();

      return true;
    }

    $('#nextBtn').on('click', ()=>{
      if(!validateAndSave()) return;
      const V = visibleQuestions();
      state.history.push(state.index);
      state.index = Math.min(state.index+1, V.length);
      renderCurrent();
    });

    $('#backBtn').on('click', ()=>{
      if(state.history.length>0){
        state.index = state.history.pop();
        renderCurrent();
      }
    });

    // Salva automaticamente quando si cambia nome (utile per tracciamento iniziale, opzionale)
    $('#user-name').on('blur', ()=>{
      const nome=($('#user-name').val()||'').trim();
      if(nome){
        // opzionale: si potrebbe inviare un evento "inizio questionario"
      }
    });

    // Avvio
    $(document).ready(()=>{
      renderCurrent();
    });
  </script>
</body>
</html>

